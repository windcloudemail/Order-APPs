<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤å•¦ - æ­·å²æŸ¥è©¢ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 650px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background-color: #0d6efd; color: white; width: 100%; padding: 12px; font-size: 1.2rem; border: none; border-radius: 50px; transition: 0.3s; }
        .btn-main:hover { background-color: #198754 !important; color: white; transform: translateY(-2px); }
        .manual-area { background-color: #fffde7; border: 1px dashed #ffd600; padding: 15px; border-radius: 10px; }
        .order-card { border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        #menuImg { max-width: 100%; border-radius: 10px; }
        .progress { height: 25px; display: none; margin-top: 10px; border-radius: 15px; }
        .summary-item { border-radius: 10px; padding: 8px 15px; margin-bottom: 5px; font-weight: bold; display: flex; justify-content: space-between; }
        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼ */
        .date-filter { background: #e9ecef; padding: 10px 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #ced4da; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 class="m-0">ğŸ¥¤ é»é¤å•¦</h2>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminModal">âš™ï¸ å¾Œå°ç®¡ç†èœå–®</button>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">é¸æ“‡åº—å®¶</label>
        <select id="shopSelect" class="form-select" onchange="checkShopImage()"><option value="">è¼‰å…¥ä¸­...</option></select>
        <button id="viewMenuBtn" class="btn btn-info btn-sm w-100 mt-2" style="display:none;" data-bs-toggle="modal" data-bs-target="#menuModal">ğŸ–¼ï¸ æŸ¥çœ‹åœ–ç‰‡èœå–®</button>
    </div>

    <div class="manual-area mb-3">
        <label class="form-label fw-bold text-primary">çœ‹åœ–é»é¤ / æ‰‹å‹•è¼¸å…¥ï¼š</label>
        <div class="row g-2">
            <div class="col-8"><input type="text" id="manualName" class="form-control" placeholder="é£²å“åç¨±"></div>
            <div class="col-4"><input type="number" id="manualPrice" class="form-control" placeholder="åƒ¹æ ¼"></div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col"><select id="sugar" class="form-select"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select></div>
            <div class="col"><select id="ice" class="form-select"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select></div>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">ä½ çš„åå­—</label>
        <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥å§“å">
    </div>

    <button onclick="submitOrder()" class="btn btn-main shadow mb-4">é€å‡ºè¨‚å–®</button>

    <div class="date-filter d-flex align-items-center justify-content-between">
        <span class="fw-bold">ğŸ“… æŸ¥è©¢æ—¥æœŸï¼š</span>
        <input type="date" id="queryDate" class="form-control form-control-sm w-50" onchange="startListening()">
    </div>

    <div class="alert alert-light border">
        <div id="summaryArea">è¼‰å…¥çµ±è¨ˆä¸­...</div>
        <div class="text-end mt-2">
            <button class="btn btn-dark btn-sm" onclick="copySummary()">ğŸ“‹ è¤‡è£½çµ±è¨ˆå…§å®¹</button>
        </div>
    </div>

    <h5 class="mt-4">ğŸ“‹ è¨‚å–®åˆ—è¡¨</h5>
    <div id="orderList"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Firebase é…ç½® (ä¿ç•™ä½ çš„åŸå§‹ Config)
    const firebaseConfig = {
        apiKey: "AIzaSyBVKIwa0GOQAdbOBjec3qRpoTouoybb-EA",
        authDomain: "order-app-7fc8d.firebaseapp.com",
        projectId: "order-app-7fc8d",
        storageBucket: "order-app-7fc8d.firebasestorage.app",
        messagingSenderId: "1048272085989",
        appId: "1:1048272085989:web:449d2de7a877436541050c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    let shopData = {};
    let todayOrders = [];
    let unsubscribe = null; // ç”¨æ–¼åˆ‡æ›æ—¥æœŸæ™‚åœæ­¢èˆŠçš„ç›£è½

    // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨ç‚ºã€Œä»Šå¤©ã€
    const todayStr = new Date().toISOString().split('T')[0];
    document.getElementById('queryDate').value = todayStr;

    // --- æ ¸å¿ƒï¼šå‹•æ…‹æ—¥æœŸç›£è½åŠŸèƒ½ ---
    function startListening() {
        const selectedDate = document.getElementById('queryDate').value;
        if (!selectedDate) return;

        // è¨ˆç®—é¸å®šæ—¥æœŸçš„ 00:00:00 èˆ‡ 23:59:59
        const startTime = new Date(selectedDate);
        startTime.setHours(0, 0, 0, 0);
        const endTime = new Date(selectedDate);
        endTime.setHours(23, 59, 59, 999);

        // å¦‚æœä¹‹å‰æœ‰ç›£è½å™¨ï¼Œå…ˆé—œæ‰ï¼Œé¿å…é‡è¤‡
        if (unsubscribe) unsubscribe();

        // é–‹å•Ÿæ–°çš„ç›£è½å™¨
        unsubscribe = db.collection("orders")
            .where("timestamp", ">=", startTime)
            .where("timestamp", "<=", endTime)
            .orderBy("timestamp", "desc")
            .onSnapshot(snap => {
                const list = document.getElementById('orderList');
                const summaryArea = document.getElementById('summaryArea');
                let shopTotals = {}; 
                todayOrders = []; 
                list.innerHTML = "";

                snap.forEach(doc => {
                    const d = doc.data();
                    todayOrders.push(d);
                    const sName = d.shop || "æœªæŒ‡å®šåº—å®¶";
                    const p = Number(d.price) || 0;

                    if (!shopTotals[sName]) shopTotals[sName] = { count: 0, sum: 0 };
                    shopTotals[sName].count++;
                    shopTotals[sName].sum += p;

                    list.innerHTML += `<div class="order-card"><b>${d.name || 'ç„¡å'}</b> [${sName}] ${d.item} ($${p})<br><small class="text-muted">${d.detail || ''}</small></div>`;
                });

                // æ¸²æŸ“åˆ†é¡çµ±è¨ˆ
                const colors = ['primary', 'success', 'info', 'warning', 'danger'];
                let colorIdx = 0;
                let summaryHtml = `<div class="fw-bold mb-2">ğŸ’° ${selectedDate} çµ±è¨ˆï¼š</div>`;
                for (let s in shopTotals) {
                    const c = colors[colorIdx % colors.length];
                    summaryHtml += `<div class="summary-item bg-light text-${c} border border-${c}"><span>ğŸ  ${s}</span><span>${shopTotals[s].count} æ¯ / ${shopTotals[s].sum} å…ƒ</span></div>`;
                    colorIdx++;
                }
                if (Object.keys(shopTotals).length === 0) summaryHtml = `ğŸ“… ${selectedDate} å°šç„¡è¨‚å–®ç´€éŒ„`;
                summaryArea.innerHTML = summaryHtml;
            });
    }

    // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ä¿æŒä¸è®Š ---
    function submitOrder() {
        const name = document.getElementById('userName').value;
        const item = document.getElementById('manualName').value;
        const price = parseInt(document.getElementById('manualPrice').value) || 0;
        const shop = document.getElementById('shopSelect').value;
        if(!name || !item || !shop) return alert("è«‹å¡«å¯«å§“åã€åº—å®¶èˆ‡é£²å“åç¨±");
        db.collection("orders").add({
            name, item, price, shop,
            detail: `${document.getElementById('sugar').value} / ${document.getElementById('ice').value}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("æˆåŠŸåŠ å…¥æ¸…å–®ï¼");
            document.getElementById('manualName').value = ""; document.getElementById('manualPrice').value = "";
        });
    }

    // (å…¶é¤˜ checkShopImage, copySummary, loadMenu ç­‰åŠŸèƒ½ç…§èˆŠ)
    // ... 
    
    // å•Ÿå‹•åˆå§‹ç›£è½
    startListening();
    loadMenu();
</script>
</body>
</html>
