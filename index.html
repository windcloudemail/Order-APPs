<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é»å - é£²æ–™é»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 700px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .order-card { border-bottom: 1px solid #eee; padding: 12px 0; }
        .btn-main { background-color: #0d6efd; color: white; width: 100%; padding: 12px; font-size: 1.2rem; border: none; transition: 0.3s; }
        .btn-main:hover { background-color: #198754; color: white; }
        .total-section { background-color: #fff; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #dee2e6; }
        .admin-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 class="m-0">ğŸ¥¤ è¶…é™½æ˜¥é£²æ–™é»é¤ç³»çµ±</h2>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminModal">âš™ï¸ æ–°å¢åº—å®¶èœå–®</button>
    </div>
    
    <div class="card p-3 mb-4 shadow-sm">
        <div class="mb-3">
            <label class="form-label fw-bold">ä½ çš„åå­—</label>
            <input type="text" id="userName" class="form-control" placeholder="è¼¸å…¥å§“å">
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">é¸æ“‡åº—å®¶</label>
                <select id="shopSelect" class="form-select" onchange="updateCategories()"><option value="">è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">é£²å“åˆ†é¡</label>
                <select id="categorySelect" class="form-select" onchange="updateDrinks()"><option value="">è«‹å…ˆé¸åº—å®¶</option></select>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">é¸æ“‡é£²å“</label>
            <select id="drinkSelect" class="form-select"><option value="">è«‹å…ˆé¸åˆ†é¡</option></select>
        </div>

        <div class="row mb-3">
            <div class="col"><select id="sugarSelect" class="form-select"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select></div>
            <div class="col"><select id="iceSelect" class="form-select"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select></div>
        </div>

        <button onclick="submitOrder()" class="btn btn-main rounded-pill">é€å‡ºè¨‚å–®</button>
    </div>

    <div class="total-section mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>ä»Šæ—¥çµ±è¨ˆï¼š<span id="totalCount" class="fw-bold">0</span> æ¯ / <span id="totalPrice" class="text-success fw-bold">0</span> å…ƒ</div>
            <button onclick="sendEmailSummary()" class="btn btn-dark btn-sm">ğŸ“§ å¯„å‡ºçµ±è¨ˆéƒµä»¶</button>
        </div>
    </div>

    <h4>ğŸ“‹ ä»Šæ—¥è¨‚å–®åˆ—è¡¨</h4>
    <div id="orderList"><p class="text-muted">ç­‰å¾…è¨‚å–®ä¸­...</p></div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5>ç®¡ç†èœå–®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="admin-section">
                    <h6>å¿«é€Ÿæ–°å¢/æ›´æ–°åº—å®¶</h6>
                    <input type="text" id="newShopName" class="form-control mb-2" placeholder="åº—å®¶åç¨±">
                    <textarea id="menuJson" class="form-control mb-2" rows="5" placeholder='è«‹è¼¸å…¥ JSON æ ¼å¼ï¼Œä¾‹å¦‚ï¼š&#10;{"å¥¶èŒ¶é¡": [{"name":"ç´…å¥¶","price":50}], "èŒ¶é¡": [{"name":"ç¶ èŒ¶","price":30}]}'></textarea>
                    <button class="btn btn-primary btn-sm" onclick="saveMenu()">å„²å­˜èœå–®</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteShop()">åˆªé™¤æ­¤åº—å®¶</button>
                </div>
                <hr>
                <h6>ç›®å‰åº—å®¶åˆ—è¡¨</h6>
                <div id="adminShopList"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
      const firebaseConfig = {
      apiKey: "AIzaSyBVKIwa0GOQAdbOBjec3qRpoTouoybb-EA",
      authDomain: "order-app-7fc8d.firebaseapp.com",
      projectId: "order-app-7fc8d",
      storageBucket: "order-app-7fc8d.firebasestorage.app",
      messagingSenderId: "1048272085989",
      appId: "1:1048272085989:web:449d2de7a877436541050c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let fullMenu = {}; // å­˜æ”¾æ‰€æœ‰åº—å®¶èœå–®
    let todayOrders = [];

    // --- 1. èœå–®ç®¡ç†åŠŸèƒ½ ---

    // è¼‰å…¥æ‰€æœ‰èœå–®
    function loadMenu() {
        db.collection("menu").onSnapshot(snapshot => {
            const shopSelect = document.getElementById('shopSelect');
            const adminShopList = document.getElementById('adminShopList');
            shopSelect.innerHTML = '<option value="">è«‹é¸æ“‡åº—å®¶</option>';
            adminShopList.innerHTML = '';
            fullMenu = {};

            snapshot.forEach(doc => {
                const shopName = doc.id;
                fullMenu[shopName] = doc.data().categories;
                shopSelect.innerHTML += `<option value="${shopName}">${shopName}</option>`;
                adminShopList.innerHTML += `<div class="d-flex justify-content-between mb-1">${shopName} <button class="btn btn-link btn-sm" onclick="editMenu('${shopName}')">ä¿®æ”¹</button></div>`;
            });
        });
    }

    function saveMenu() {
        const name = document.getElementById('newShopName').value;
        const json = document.getElementById('menuJson').value;
        if(!name || !json) return alert("è«‹å¡«å¯«åç¨±èˆ‡å…§å®¹");
        try {
            const categories = JSON.parse(json);
            db.collection("menu").doc(name).set({ categories }).then(() => {
                alert("å„²å­˜æˆåŠŸï¼");
                document.getElementById('newShopName').value = '';
                document.getElementById('menuJson').value = '';
            });
        } catch(e) { alert("JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ï¼"); }
    }

    function editMenu(name) {
        document.getElementById('newShopName').value = name;
        document.getElementById('menuJson').value = JSON.stringify(fullMenu[name], null, 2);
    }

    function deleteShop() {
        const name = document.getElementById('newShopName').value;
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ ${name} å—ï¼Ÿ`)) {
            db.collection("menu").doc(name).delete().then(() => alert("å·²åˆªé™¤"));
        }
    }

    // --- 2. é»é¤ä»‹é¢é€£å‹• ---

    function updateCategories() {
        const shop = document.getElementById('shopSelect').value;
        const catSelect = document.getElementById('categorySelect');
        catSelect.innerHTML = '<option value="">é¸æ“‡åˆ†é¡</option>';
        document.getElementById('drinkSelect').innerHTML = '<option value="">è«‹å…ˆé¸åˆ†é¡</option>';
        if(shop && fullMenu[shop]) {
            Object.keys(fullMenu[shop]).forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
    }

    function updateDrinks() {
        const shop = document.getElementById('shopSelect').value;
        const cat = document.getElementById('categorySelect').value;
        const drinkSelect = document.getElementById('drinkSelect');
        drinkSelect.innerHTML = '<option value="">é¸æ“‡é£²å“</option>';
        if(cat && fullMenu[shop][cat]) {
            fullMenu[shop][cat].forEach(item => {
                drinkSelect.innerHTML += `<option value="${item.name}|${item.price}">${item.name} ($${item.price})</option>`;
            });
        }
    }

    // --- 3. è¨‚å–®èˆ‡çµ±è¨ˆ ---

    function submitOrder() {
        const name = document.getElementById('userName').value;
        const shop = document.getElementById('shopSelect').value;
        const drinkVal = document.getElementById('drinkSelect').value;
        if(!name || !shop || !drinkVal) return alert("è«‹å¡«å¯«å®Œæ•´é»é¤è³‡è¨Š");

        const [drinkName, price] = drinkVal.split('|');
        db.collection("orders").add({
            name, shop, item: drinkName, price: parseInt(price),
            detail: `${document.getElementById('sugarSelect').value} / ${document.getElementById('iceSelect').value}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { alert("é»é¤æˆåŠŸï¼"); document.getElementById('userName').value = ''; });
    }

    const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
    db.collection("orders").where("timestamp", ">=", startOfToday).orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const listDiv = document.getElementById('orderList');
        let count = 0, total = 0; todayOrders = [];
        listDiv.innerHTML = "";
        snapshot.forEach(doc => {
            const d = doc.data(); todayOrders.push(d);
            count++; total += d.price || 0;
            listDiv.innerHTML += `<div class="order-card"><strong>${d.name}</strong> [${d.shop}] ${d.item} ($${d.price})<br><small class="text-muted">${d.detail}</small></div>`;
        });
        document.getElementById('totalCount').innerText = count;
        document.getElementById('totalPrice').innerText = total;
    });

    function sendEmailSummary() {
        if (todayOrders.length === 0) return alert("å°šç„¡è¨‚å–®");
        let body = "ä»Šæ—¥è¨‚å–®å½™æ•´ï¼š\n\n";
        todayOrders.forEach((o, i) => body += `${i+1}. ${o.name}: ${o.shop}-${o.item} (${o.detail}) $${o.price}\n`);
        window.location.href = `mailto:?subject=è¨‚å–®çµ±è¨ˆ&body=${encodeURIComponent(body)}`;
    }

    loadMenu();
</script>
</body>
</html>
