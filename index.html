<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é»å - é£²æ–™é»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 700px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .card-custom { border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #fff; }
        .btn-main { background-color: #0d6efd; color: white; width: 100%; padding: 12px; font-size: 1.2rem; border: none; transition: 0.3s; }
        .btn-main:hover { background-color: #198754; color: white; }
        .admin-cat-card { background: #f8f9fa; border: 1px dashed #ccc; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .total-section { background-color: #fff; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 class="m-0">ğŸ¥¤ è¶…é™½æ˜¥é£²æ–™é»é¤ç³»çµ±</h2>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminModal" onclick="resetAdminForm()">âš™ï¸ æ–°å¢åº—å®¶èœå–®</button>
    </div>
    
    <div class="card-custom shadow-sm">
        <div class="mb-3">
            <label class="form-label fw-bold">ä½ çš„åå­—</label>
            <input type="text" id="userName" class="form-control" placeholder="è¼¸å…¥å§“å">
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">é¸æ“‡åº—å®¶</label>
                <select id="shopSelect" class="form-select" onchange="updateCategories()"><option value="">è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">é£²å“åˆ†é¡</label>
                <select id="categorySelect" class="form-select" onchange="updateDrinks()"><option value="">è«‹å…ˆé¸åº—å®¶</option></select>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">é¸æ“‡é£²å“</label>
            <select id="drinkSelect" class="form-select"><option value="">è«‹å…ˆé¸åˆ†é¡</option></select>
        </div>
        <div class="row mb-3">
            <div class="col"><select id="sugarSelect" class="form-select"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select></div>
            <div class="col"><select id="iceSelect" class="form-select"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select></div>
        </div>
        <button onclick="submitOrder()" class="btn btn-main rounded-pill">é€å‡ºè¨‚å–®</button>
    </div>

    <div class="total-section mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>ä»Šæ—¥ï¼š<span id="totalCount" class="fw-bold">0</span> æ¯ / <span id="totalPrice" class="text-success fw-bold">0</span> å…ƒ</div>
            <button onclick="sendEmailSummary()" class="btn btn-dark btn-sm">ğŸ“§ å¯„å‡ºçµ±è¨ˆéƒµä»¶</button>
        </div>
    </div>
    <h4>ğŸ“‹ ä»Šæ—¥è¨‚å–®åˆ—è¡¨</h4>
    <div id="orderList"><p class="text-muted">ç­‰å¾…è¨‚å–®ä¸­...</p></div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5>ğŸ› ï¸ èœå–®ç®¡ç†å¾Œå°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>1. åº—å®¶åŸºæœ¬è¨­å®š</h6>
                    <div class="input-group mb-2">
                        <span class="input-group-text">åº—å®¶åç¨±</span>
                        <input type="text" id="adminShopName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¶…é™½æ˜¥é£²æ–™åº—">
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>2. è¨­å®šåˆ†é¡èˆ‡é£²å“</h6>
                    <div id="adminCategoryContainer">
                        </div>
                    <button class="btn btn-success btn-sm w-100 mt-2" onclick="addAdminCategory()">â• æ–°å¢ä¸€å€‹åˆ†é¡ (å¦‚ï¼šå¥¶èŒ¶é¡)</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger me-auto" onclick="deleteShop()">åˆªé™¤æ­¤åº—å®¶</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveMenu()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒèœå–®</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- Firebase é…ç½® (è«‹ä¿æŒä½ çš„ Config) ---
const firebaseConfig = {
  apiKey: "AIzaSyBVKIwa0GOQAdbOBjec3qRpoTouoybb-EA",
  authDomain: "order-app-7fc8d.firebaseapp.com",
  projectId: "order-app-7fc8d",
  storageBucket: "order-app-7fc8d.firebasestorage.app",
  messagingSenderId: "1048272085989",
  appId: "1:1048272085989:web:449d2de7a877436541050c"
};


    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let fullMenu = {}; 
    let todayOrders = [];

    // --- å¾Œå°ç·¨è¼¯åŠŸèƒ½ (æŒ‰éˆ•èˆ‡è¼¸å…¥) ---

    function addAdminCategory(name = "", items = []) {
        const container = document.getElementById('adminCategoryContainer');
        const catId = Date.now();
        const div = document.createElement('div');
        div.className = 'admin-cat-card';
        div.id = `cat-${catId}`;
        div.innerHTML = `
            <div class="d-flex mb-2">
                <input type="text" class="form-control form-control-sm fw-bold cat-name" placeholder="åˆ†é¡åç¨±" value="${name}">
                <button class="btn btn-outline-danger btn-sm ms-2" onclick="document.getElementById('cat-${catId}').remove()">åˆªé™¤åˆ†é¡</button>
            </div>
            <div class="item-container ms-3"></div>
            <button class="btn btn-outline-primary btn-sm ms-3 mt-2" onclick="addAdminItem('${catId}')">â• æ–°å¢é£²å“</button>
        `;
        container.appendChild(div);
        items.forEach(item => addAdminItem(catId, item.name, item.price));
    }

    function addAdminItem(catId, name = "", price = "") {
        const container = document.querySelector(`#cat-${catId} .item-container`);
        const itemDiv = document.createElement('div');
        itemDiv.className = 'input-group input-group-sm mb-1';
        itemDiv.innerHTML = `
            <input type="text" class="form-control item-name" placeholder="é£²å“åç¨±" value="${name}">
            <span class="input-group-text">$</span>
            <input type="number" class="form-control item-price" placeholder="åƒ¹æ ¼" value="${price}">
            <button class="btn btn-outline-secondary" onclick="this.parentElement.remove()">âŒ</button>
        `;
        container.appendChild(itemDiv);
    }

    function saveMenu() {
        const shopName = document.getElementById('adminShopName').value;
        if(!shopName) return alert("è«‹å¡«å¯«åº—å®¶åç¨±");

        const menuData = {};
        const categories = document.querySelectorAll('.admin-cat-card');
        categories.forEach(cat => {
            const catName = cat.querySelector('.cat-name').value;
            const items = [];
            cat.querySelectorAll('.item-container > div').forEach(item => {
                const name = item.querySelector('.item-name').value;
                const price = item.querySelector('.item-price').value;
                if(name && price) items.push({ name, price: parseInt(price) });
            });
            if(catName) menuData[catName] = items;
        });

        db.collection("menu").doc(shopName).set({ categories: menuData }).then(() => {
            alert("èœå–®ç™¼å¸ƒæˆåŠŸï¼");
            bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
        });
    }

    function resetAdminForm() {
        document.getElementById('adminShopName').value = "";
        document.getElementById('adminCategoryContainer').innerHTML = "";
    }

    // --- å‰å°è¼‰å…¥èˆ‡äº’å‹• ---

    function loadMenu() {
        db.collection("menu").onSnapshot(snapshot => {
            const shopSelect = document.getElementById('shopSelect');
            shopSelect.innerHTML = '<option value="">é¸æ“‡åº—å®¶</option>';
            fullMenu = {};
            snapshot.forEach(doc => {
                fullMenu[doc.id] = doc.data().categories;
                shopSelect.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
            });
        });
    }

    function updateCategories() {
        const shop = document.getElementById('shopSelect').value;
        const catSelect = document.getElementById('categorySelect');
        catSelect.innerHTML = '<option value="">é¸æ“‡åˆ†é¡</option>';
        if(shop && fullMenu[shop]) {
            Object.keys(fullMenu[shop]).forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }
    }

    function updateDrinks() {
        const shop = document.getElementById('shopSelect').value;
        const cat = document.getElementById('categorySelect').value;
        const drinkSelect = document.getElementById('drinkSelect');
        drinkSelect.innerHTML = '<option value="">é¸æ“‡é£²å“</option>';
        if(cat && fullMenu[shop][cat]) {
            fullMenu[shop][cat].forEach(item => {
                drinkSelect.innerHTML += `<option value="${item.name}|${item.price}">${item.name} ($${item.price})</option>`;
            });
        }
    }

    // --- è¨‚å–®è™•ç† (ä¿æŒåŸæœ¬é‚è¼¯) ---
    function submitOrder() {
        const name = document.getElementById('userName').value;
        const drinkVal = document.getElementById('drinkSelect').value;
        if(!name || !drinkVal) return alert("è«‹å¡«å¯«å§“åèˆ‡é£²å“");
        const [dName, dPrice] = drinkVal.split('|');
        db.collection("orders").add({
            name, item: dName, price: parseInt(dPrice),
            detail: `${document.getElementById('sugarSelect').value} / ${document.getElementById('iceSelect').value}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => { alert("é»é¤æˆåŠŸï¼"); document.getElementById('userName').value=''; });
    }

    const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
    db.collection("orders").where("timestamp", ">=", startOfToday).orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const listDiv = document.getElementById('orderList');
        let count = 0, total = 0; todayOrders = [];
        listDiv.innerHTML = "";
        snapshot.forEach(doc => {
            const d = doc.data(); todayOrders.push(d);
            count++; total += (d.price || 0);
            listDiv.innerHTML += `<div class="order-card"><strong>${d.name}</strong> é»äº† ${d.item} ($${d.price})<br><small class="text-muted">${d.detail}</small></div>`;
        });
        document.getElementById('totalCount').innerText = count;
        document.getElementById('totalPrice').innerText = total;
    });

    loadMenu();
</script>
</body>
</html>
