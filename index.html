<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤å•¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 650px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background-color: #0d6efd; color: white; width: 100%; padding: 12px; font-size: 1.2rem; border: none; border-radius: 50px; transition: 0.3s; }
        .btn-main:hover { background-color: #198754 !important; color: white; transform: translateY(-2px); }
        .manual-area { background-color: #fffde7; border: 1px dashed #ffd600; padding: 15px; border-radius: 10px; }
        .order-card { border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        #menuImg { max-width: 100%; border-radius: 10px; }
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress { height: 25px; display: none; margin-top: 10px; border-radius: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 class="m-0">ğŸ¥¤ é»é¤å•¦</h2>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminModal">âš™ï¸ å¾Œå°ç®¡ç†èœå–®</button>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">ä½ çš„åå­—</label>
        <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥å§“å">
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">é¸æ“‡åº—å®¶</label>
        <select id="shopSelect" class="form-select" onchange="checkShopImage()"><option value="">è¼‰å…¥ä¸­...</option></select>
        <button id="viewMenuBtn" class="btn btn-info btn-sm w-100 mt-2" style="display:none;" data-bs-toggle="modal" data-bs-target="#menuModal">ğŸ–¼ï¸ æŸ¥çœ‹åœ–ç‰‡èœå–®</button>
    </div>

    <div class="manual-area mb-3">
        <label class="form-label fw-bold text-primary">çœ‹åœ–é»é¤ / æ‰‹å‹•è¼¸å…¥ï¼š</label>
        <div class="row g-2">
            <div class="col-8"><input type="text" id="manualName" class="form-control" placeholder="é£²å“åç¨±"></div>
            <div class="col-4"><input type="number" id="manualPrice" class="form-control" placeholder="åƒ¹æ ¼"></div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col"><select id="sugar" class="form-select"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select></div>
            <div class="col"><select id="ice" class="form-select"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select></div>
        </div>
    </div>

    <button onclick="submitOrder()" class="btn btn-main shadow">é€å‡ºè¨‚å–®</button>

    <div class="alert alert-light border mt-4 d-flex justify-content-between align-items-center">
        <span>ä»Šæ—¥ç¸½è¨ˆï¼š<b id="tCount">0</b> æ¯ / <b id="tPrice" class="text-success">0</b> å…ƒ</span>
        <button class="btn btn-dark btn-sm" onclick="sendEmail()">ğŸ“§ å¯„å‡ºçµ±è¨ˆ</button>
    </div>

    <h5 class="mt-4">ğŸ“‹ ä»Šæ—¥è¨‚å–®åˆ—è¡¨</h5>
    <div id="orderList"></div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5>èœå–®åœ–ç‰‡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body text-center"><img id="menuImg" src=""></div>
</div></div></div>

<div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5>ğŸ› ï¸ èœå–®ç®¡ç†å¾Œå°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <div class="mb-3">
            <label class="form-label fw-bold">é¸æ“‡æ“ä½œæ¨¡å¼ï¼š</label>
            <select id="adminMode" class="form-select mb-3" onchange="toggleAdminUI()">
                <option value="add">æ–°å¢åº—å®¶</option>
                <option value="edit">ä¿®æ”¹ç¾æœ‰èœå–®</option>
                <option value="delete">åˆªé™¤åº—å®¶</option>
            </select>
        </div>

        <div id="divAdminNewShop" class="mb-3">
            <label class="form-label">è¼¸å…¥æ–°åº—å®¶åç¨±</label>
            <input type="text" id="adminNewName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¿·å®¢å¤">
        </div>

        <div id="divAdminSelectShop" class="mb-3" style="display:none;">
            <label class="form-label">é¸æ“‡è¦è™•ç†çš„åº—å®¶</label>
            <select id="adminShopSelect" class="form-select"></select>
        </div>

        <div id="divAdminFile" class="mb-3">
            <label class="form-label">ä¸Šå‚³æ–°èœå–®åœ–ç‰‡</label>
            <input type="file" id="adminFile" class="form-control" accept="image/*">
        </div>

        <div class="progress" id="uploadProgress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div>
        </div>

        <button id="adminSubmitBtn" class="btn btn-primary w-100 mt-3" onclick="handleAdminAction()">åŸ·è¡Œæ“ä½œ</button>
    </div>
</div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyBVKIwa0GOQAdbOBjec3qRpoTouoybb-EA",
  authDomain: "order-app-7fc8d.firebaseapp.com",
  projectId: "order-app-7fc8d",
  storageBucket: "order-app-7fc8d.firebasestorage.app",
  messagingSenderId: "1048272085989",
  appId: "1:1048272085989:web:449d2de7a877436541050c"
};


    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    let shopData = {};

    // --- ä»‹é¢åˆ‡æ›é‚è¼¯ ---
    function toggleAdminUI() {
        const mode = document.getElementById('adminMode').value;
        document.getElementById('divAdminNewShop').style.display = (mode === 'add') ? 'block' : 'none';
        document.getElementById('divAdminSelectShop').style.display = (mode !== 'add') ? 'block' : 'none';
        document.getElementById('divAdminFile').style.display = (mode !== 'delete') ? 'block' : 'none';
        document.getElementById('adminSubmitBtn').innerText = (mode === 'delete') ? 'ç¢ºå®šåˆªé™¤åº—å®¶' : 'ä¸Šå‚³ä¸¦å„²å­˜èœå–®';
        document.getElementById('adminSubmitBtn').className = (mode === 'delete') ? 'btn btn-danger w-100 mt-3' : 'btn btn-primary w-100 mt-3';
    }

    // --- è¼‰å…¥åº—å®¶åˆ—è¡¨ ---
    db.collection("menu").onSnapshot(snap => {
        const sel = document.getElementById('shopSelect');
        const admSel = document.getElementById('adminShopSelect');
        sel.innerHTML = '<option value="">è«‹é¸æ“‡åº—å®¶</option>';
        admSel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        shopData = {};
        snap.forEach(doc => {
            shopData[doc.id] = doc.data();
            sel.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
            admSel.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    });

    // --- æ ¸å¿ƒï¼šè™•ç†ç®¡ç†å“¡å‹•ä½œ (å«é€²åº¦æ¢) ---
    async function handleAdminAction() {
        const mode = document.getElementById('adminMode').value;
        let shopName = "";
        
        if (mode === 'add') {
            shopName = document.getElementById('adminNewName').value;
        } else {
            shopName = document.getElementById('adminShopSelect').value;
        }

        if (!shopName) return alert("è«‹å¡«å¯«æˆ–é¸æ“‡åº—å®¶åç¨±");

        // åˆªé™¤é‚è¼¯
        if (mode === 'delete') {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${shopName}ã€å—ï¼Ÿæ‰€æœ‰çš„åœ–ç‰‡èˆ‡é¸å–®ç´€éŒ„å°‡æœƒæ¶ˆå¤±ã€‚`)) return;
            await db.collection("menu").doc(shopName).delete();
            alert("åº—å®¶å·²åˆªé™¤");
            bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
            return;
        }

        // æ–°å¢èˆ‡ä¿®æ”¹é‚è¼¯ (éœ€è¦ä¸Šå‚³)
        const file = document.getElementById('adminFile').files[0];
        if (!file) return alert("è«‹é¸æ“‡èœå–®åœ–ç‰‡æª”æ¡ˆ");

        // é–å®šæŒ‰éˆ•èˆ‡é¡¯ç¤ºé€²åº¦æ¢
        const btn = document.getElementById('adminSubmitBtn');
        const progDiv = document.getElementById('uploadProgress');
        const progBar = document.getElementById('progressBar');
        btn.disabled = true;
        progDiv.style.display = 'flex';

        const storageRef = storage.ref(`menus/${shopName}_${Date.now()}`);
        const uploadTask = storageRef.put(file);

        // ç›£è½é€²åº¦
        uploadTask.on('state_changed', 
            (snapshot) => {
                const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                progBar.style.width = percent + '%';
                progBar.innerText = percent + '%';
            }, 
            (error) => {
                alert("ä¸Šå‚³å¤±æ•—ï¼š" + error.message);
                btn.disabled = false;
            }, 
            async () => {
                const url = await uploadTask.snapshot.ref.getDownloadURL();
                await db.collection("menu").doc(shopName).set({ imageUrl: url });
                
                // å®Œæˆå¾Œå‹•ä½œ
                alert("ğŸ‰ ä¸Šå‚³æˆåŠŸï¼èœå–®å·²æ›´æ–°ã€‚");
                btn.disabled = false;
                progDiv.style.display = 'none';
                progBar.style.width = '0%';
                document.getElementById('adminNewName').value = "";
                document.getElementById('adminFile').value = "";
                bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
            }
        );
    }

    // --- å‰å°é‚è¼¯ (ä¿æŒä¸è®Š) ---
    function checkShopImage() {
        const shop = document.getElementById('shopSelect').value;
        const btn = document.getElementById('viewMenuBtn');
        if(shop && shopData[shop]?.imageUrl) {
            btn.style.display = 'block';
            document.getElementById('menuImg').src = shopData[shop].imageUrl;
        } else { btn.style.display = 'none'; }
    }

    function submitOrder() {
        const name = document.getElementById('userName').value;
        const item = document.getElementById('manualName').value;
        const price = parseInt(document.getElementById('manualPrice').value) || 0;
        const shop = document.getElementById('shopSelect').value;
        if(!name || !item || !shop) return alert("è«‹å¡«å¯«å§“åã€åº—å®¶èˆ‡é£²å“åç¨±");
        db.collection("orders").add({
            name, item, price, shop,
            detail: `${document.getElementById('sugar').value} / ${document.getElementById('ice').value}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("æˆåŠŸåŠ å…¥æ¸…å–®ï¼");
            document.getElementById('manualName').value = "";
            document.getElementById('manualPrice').value = "";
        });
    }

    const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
    db.collection("orders").where("timestamp", ">=", startOfToday).orderBy("timestamp", "desc").onSnapshot(snap => {
        const list = document.getElementById('orderList');
        let count = 0, total = 0;
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data(); count++; total += d.price;
            list.innerHTML += `<div class="order-card"><b>${d.name}</b> [${d.shop}] ${d.item} ($${d.price})<br><small class="text-muted">${d.detail}</small></div>`;
        });
        document.getElementById('tCount').innerText = count;
        document.getElementById('tPrice').innerText = total;
    });

    function sendEmail() {
        // ... (çœç•¥èˆ‡ä¹‹å‰ç›¸åŒçš„ mailto é‚è¼¯)
    }
</script>
</body>
</html>
