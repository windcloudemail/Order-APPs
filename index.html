<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é»å (Roll Call) - å°ˆæ¥­ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 650px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* é€å‡ºè¨‚å–®æŒ‰éˆ•æ¨£å¼èˆ‡ Hover æ•ˆæœ */
        .btn-main { 
            background-color: #0d6efd; color: white; width: 100%; padding: 12px; 
            font-size: 1.2rem; border: none; border-radius: 50px; transition: 0.3s; 
        }
        .btn-main:hover { background-color: #198754 !important; color: white; transform: translateY(-2px); }
        
        .manual-area { background-color: #fffde7; border: 1px dashed #ffd600; padding: 15px; border-radius: 10px; }
        .order-card { border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        #menuImg { max-width: 100%; border-radius: 10px; cursor: zoom-in; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 class="m-0">ğŸ¥¤ é»é»å (Order APPs)</h2>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminModal">âš™ï¸ ç®¡ç†å“¡ä¸Šå‚³èœå–®</button>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">ä½ çš„åå­—</label>
        <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥å§“å">
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">é¸æ“‡åº—å®¶</label>
        <select id="shopSelect" class="form-select" onchange="checkShopImage()"><option value="">è¼‰å…¥ä¸­...</option></select>
        <button id="viewMenuBtn" class="btn btn-info btn-sm w-100 mt-2" style="display:none;" data-bs-toggle="modal" data-bs-target="#menuModal">ğŸ–¼ï¸ é»æˆ‘æŸ¥çœ‹åœ–ç‰‡èœå–®</button>
    </div>

    <div class="manual-area mb-3">
        <label class="form-label fw-bold text-primary">çœ‹åœ–é»é¤ / æ‰‹å‹•è¼¸å…¥ï¼š</label>
        <div class="row g-2">
            <div class="col-8"><input type="text" id="manualName" class="form-control" placeholder="å“é …åç¨± (å¦‚ï¼šè‹±å€«å¥¶èŒ¶)"></div>
            <div class="col-4"><input type="number" id="manualPrice" class="form-control" placeholder="åƒ¹æ ¼"></div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col"><select id="sugar" class="form-select"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select></div>
            <div class="col"><select id="ice" class="form-select"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select></div>
        </div>
    </div>

    <button onclick="submitOrder()" class="btn btn-main shadow">é€å‡ºè¨‚å–®</button>

    <div class="alert alert-light border mt-4 d-flex justify-content-between align-items-center">
        <span>ä»Šæ—¥ç¸½è¨ˆï¼š<b id="tCount">0</b> æ¯ / <b id="tPrice" class="text-success">0</b> å…ƒ</span>
        <button class="btn btn-dark btn-sm" onclick="sendEmail()">ğŸ“§ å¯„å‡ºçµ±è¨ˆ</button>
    </div>

    <h5 class="mt-4">ğŸ“‹ ä»Šæ—¥è¨‚å–®åˆ—è¡¨</h5>
    <div id="orderList"><p class="text-muted">ç›®å‰å°šç„¡è¨‚å–®</p></div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">èœå–®åœ–ç‰‡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body text-center"><img id="menuImg" src=""></div>
</div></div></div>

<div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5>ç®¡ç†åº—å®¶èˆ‡èœå–®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <input type="text" id="admShop" class="form-control mb-2" placeholder="åº—å®¶åç¨±">
        <input type="file" id="admFile" class="form-control mb-2" accept="image/*">
        <button class="btn btn-primary w-100" onclick="uploadMenu()">ğŸš€ ä¸Šå‚³ä¸¦å„²å­˜</button>
    </div>
</div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // â–¼ è«‹å¡«å…¥ä½ çš„ Firebase Config â–¼
const firebaseConfig = {
  apiKey: "AIzaSyBVKIwa0GOQAdbOBjec3qRpoTouoybb-EA",
  authDomain: "order-app-7fc8d.firebaseapp.com",
  projectId: "order-app-7fc8d",
  storageBucket: "order-app-7fc8d.firebasestorage.app",
  messagingSenderId: "1048272085989",
  appId: "1:1048272085989:web:449d2de7a877436541050c"
};


    // åˆå§‹åŒ– Firebase (ä½¿ç”¨ç›¸å®¹ç‰ˆå¯«æ³•ï¼Œè§£æ±º initializeApp is not defined)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    let shopData = {};
    let todayOrders = [];

    // --- èœå–®ç®¡ç† ---
    async function uploadMenu() {
        const name = document.getElementById('admShop').value;
        const file = document.getElementById('admFile').files[0];
        if(!name || !file) return alert("è«‹å¡«å¯«åº—å®¶åç¨±ä¸¦é¸æ“‡åœ–ç‰‡");

        const ref = storage.ref(`menus/${name}_${Date.now()}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();

        await db.collection("menu").doc(name).set({ imageUrl: url });
        alert("ä¸Šå‚³æˆåŠŸï¼");
        location.reload();
    }

    // --- è¼‰å…¥åº—å®¶ ---
    db.collection("menu").onSnapshot(snap => {
        const sel = document.getElementById('shopSelect');
        sel.innerHTML = '<option value="">è«‹é¸æ“‡åº—å®¶</option>';
        snap.forEach(doc => {
            shopData[doc.id] = doc.data();
            sel.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    });

    function checkShopImage() {
        const shop = document.getElementById('shopSelect').value;
        const btn = document.getElementById('viewMenuBtn');
        const img = document.getElementById('menuImg');
        if(shop && shopData[shop]?.imageUrl) {
            btn.style.display = 'block';
            img.src = shopData[shop].imageUrl;
        } else {
            btn.style.display = 'none';
        }
    }

    // --- ä¸‹å–®é‚è¼¯ ---
    function submitOrder() {
        const name = document.getElementById('userName').value;
        const item = document.getElementById('manualName').value;
        const price = parseInt(document.getElementById('manualPrice').value) || 0;
        const shop = document.getElementById('shopSelect').value;

        if(!name || !item || !shop) return alert("è«‹å¡«å¯«å§“åã€åº—å®¶èˆ‡é£²å“åç¨±");

        db.collection("orders").add({
            name, item, price, shop,
            detail: `${document.getElementById('sugar').value} / ${document.getElementById('ice').value}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("é»é¤æˆåŠŸï¼");
            document.getElementById('manualName').value = "";
            document.getElementById('manualPrice').value = "";
        });
    }

    // --- ä»Šæ—¥è¨‚å–®ç›£è½ (ä»¥æ—¥ç‚ºå–®ä½) ---
    const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
    db.collection("orders").where("timestamp", ">=", startOfToday).orderBy("timestamp", "desc").onSnapshot(snap => {
        const list = document.getElementById('orderList');
        let count = 0, total = 0; todayOrders = [];
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data(); todayOrders.push(d);
            count++; total += d.price;
            list.innerHTML += `<div class="order-card"><b>${d.name}</b> [${d.shop}] ${d.item} ($${d.price})<br><small class="text-muted">${d.detail}</small></div>`;
        });
        document.getElementById('tCount').innerText = count;
        document.getElementById('tPrice').innerText = total;
    });

    function sendEmail() {
        if(!todayOrders.length) return alert("å°šç„¡è¨‚å–®");
        let body = "ä»Šæ—¥è¨‚å–®å½™æ•´ï¼š\n\n";
        todayOrders.forEach((o, i) => body += `${i+1}. ${o.name}: ${o.shop}-${o.item} $${o.price}\n`);
        window.location.href = `mailto:?subject=é»é»åè¨‚å–®çµ±è¨ˆ&body=${encodeURIComponent(body)}`;
    }
</script>
</body>
</html>
