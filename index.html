<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤å•¦ - å¾Œå°é‚è¼¯å„ªåŒ–ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 650px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-main { background-color: #0d6efd; color: white; width: 100%; padding: 12px; font-size: 1.2rem; border: none; border-radius: 50px; transition: 0.3s; }
        .btn-main:hover { background-color: #198754 !important; color: white; transform: translateY(-2px); }
        .manual-area { background-color: #fffde7; border: 1px dashed #ffd600; padding: 15px; border-radius: 10px; }
        select:disabled { background-color: #adb5bd !important; color: #495057 !important; cursor: not-allowed; border-color: #6c757d; }
        .order-card { border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        #menuImg { max-width: 100%; border-radius: 10px; }
        .progress { height: 25px; display: none; margin-top: 10px; border-radius: 15px; }
        .summary-item { border-radius: 10px; padding: 8px 15px; margin-bottom: 5px; font-weight: bold; display: flex; justify-content: space-between; }
        .date-filter { background: #e9ecef; padding: 10px 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #ced4da; }
        
        /* æ‰‹æ©Ÿç‰ˆæ’ç‰ˆå„ªåŒ– */
        @media (max-width: 576px) {
            .manual-area .col-8, .manual-area .col-4 { width: 100%; }
            .manual-area .row.g-2 > div { margin-bottom: 8px; }
            .col-temp { width: 100% !important; }
            .col-sugar, .col-ice { width: 50% !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 class="m-0">ğŸ¥¤ é»é¤å•¦</h2>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#adminModal" onclick="resetAdminUI()">âš™ï¸ å¾Œå°ç®¡ç†</button>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">é¸æ“‡åº—å®¶</label>
        <select id="shopSelect" class="form-select" onchange="checkShopImage()"><option value="">è¼‰å…¥ä¸­...</option></select>
        <button id="viewMenuBtn" class="btn btn-info btn-sm w-100 mt-2" style="display:none;" data-bs-toggle="modal" data-bs-target="#menuModal">ğŸ–¼ï¸ æŸ¥çœ‹åœ–ç‰‡èœå–®</button>
    </div>

    <div class="manual-area mb-3">
        <label class="form-label fw-bold text-primary">çœ‹åœ–é»é¤ / æ‰‹å‹•è¼¸å…¥ï¼š</label>
        <div class="row g-2 mb-2">
            <div class="col-8 col-sm-8"><input type="text" id="manualName" class="form-control" placeholder="é£²å“åç¨±"></div>
            <div class="col-4 col-sm-4"><input type="number" id="manualPrice" class="form-control" placeholder="åƒ¹æ ¼"></div>
        </div>
        <div class="row g-2">
            <div class="col-12 col-sm-4 col-temp">
                <select id="tempSelect" class="form-select" onchange="toggleIceSelect()">
                    <option value="å†·">ğŸ§Š å†·é£²</option><option value="ç†±">â™¨ï¸ ç†±é£²</option>
                </select>
            </div>
            <div class="col-6 col-sm-4 col-sugar">
                <select id="sugar" class="form-select"><option>æ­£å¸¸ç³–</option><option>åŠç³–</option><option>å¾®ç³–</option><option>ç„¡ç³–</option></select>
            </div>
            <div class="col-6 col-sm-4 col-ice">
                <select id="ice" class="form-select"><option>æ­£å¸¸å†°</option><option>å°‘å†°</option><option>å¾®å†°</option><option>å»å†°</option></select>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">ä½ çš„åå­—</label>
        <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥å§“å">
    </div>
    <button onclick="submitOrder()" class="btn btn-main shadow mb-4">é€å‡ºè¨‚å–®</button>

    <div class="date-filter d-flex align-items-center justify-content-between">
        <span class="fw-bold">ğŸ“… æŸ¥è©¢æ—¥æœŸï¼š</span>
        <input type="date" id="queryDate" class="form-control form-control-sm w-50" onchange="startListening()">
    </div>
    <div class="alert alert-light border"><div id="summaryArea">è¼‰å…¥çµ±è¨ˆä¸­...</div><div class="text-end mt-2"><button class="btn btn-dark btn-sm" onclick="copySummary()">ğŸ“‹ è¤‡è£½çµ±è¨ˆå…§å®¹</button></div></div>
    <h5 class="mt-4">ğŸ“‹ è¨‚å–®åˆ—è¡¨</h5><div id="orderList"></div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>ğŸ› ï¸ èœå–®ç®¡ç†å¾Œå°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">é¸æ“‡æ“ä½œæ¨¡å¼ï¼š</label>
                    <select id="adminMode" class="form-select mb-3" onchange="toggleAdminUI()">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="add">æ–°å¢åº—å®¶</option>
                        <option value="edit">ä¿®æ”¹ç¾æœ‰èœå–®</option>
                        <option value="delete">åˆªé™¤åº—å®¶</option>
                    </select>
                </div>

                <div id="adminInputGroup" style="display:none;">
                    <div id="divAdminNewShop" class="mb-3" style="display:none;">
                        <label class="form-label">è¼¸å…¥æ–°åº—å®¶åç¨±</label>
                        <input type="text" id="adminNewName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¿·å®¢å¤">
                    </div>

                    <div id="divAdminSelectShop" class="mb-3" style="display:none;">
                        <label class="form-label">é¸æ“‡è¦è™•ç†çš„åº—å®¶</label>
                        <select id="adminShopSelect" class="form-select"></select>
                    </div>

                    <div id="divAdminFile" class="mb-3" style="display:none;">
                        <label class="form-label">ä¸Šå‚³èœå–®åœ–ç‰‡</label>
                        <input type="file" id="adminFile" class="form-control" accept="image/*">
                    </div>

                    <div class="progress" id="uploadProgress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div>
                    </div>

                    <button id="adminSubmitBtn" class="btn btn-primary w-100 mt-3" onclick="handleAdminAction()">åŸ·è¡Œæ“ä½œ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-success text-white border-0"><h5 class="modal-title">ğŸ‰ é»å–®æˆåŠŸ</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body py-4 px-4 text-center"><h5 id="successMsgHeader" class="mb-3"></h5><p id="successMsgDetail" class="lead text-secondary"></p><button type="button" class="btn btn-success w-100 rounded-pill mt-3" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button></div></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBVKIwa0GOQAdbOBjec3qRpoTouoybb-EA",
        authDomain: "order-app-7fc8d.firebaseapp.com",
        projectId: "order-app-7fc8d",
        storageBucket: "order-app-7fc8d.firebasestorage.app",
        messagingSenderId: "1048272085989",
        appId: "1:1048272085989:web:449d2de7a877436541050c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    let shopData = {}, todayOrders = [], unsubscribeOrders = null;

    // --- å¾Œå°ç®¡ç† UI åˆ‡æ› (ä¿®æ­£é‚è¼¯) ---
    function toggleAdminUI() {
        const mode = document.getElementById('adminMode').value;
        const inputGroup = document.getElementById('adminInputGroup');
        const divNew = document.getElementById('divAdminNewShop');
        const divSelect = document.getElementById('divAdminSelectShop');
        const divFile = document.getElementById('divAdminFile');
        const btn = document.getElementById('adminSubmitBtn');

        if (!mode) {
            inputGroup.style.display = 'none';
            return;
        }

        inputGroup.style.display = 'block';
        
        // æ¨¡å¼åˆ¤æ–·
        if (mode === 'add') {
            divNew.style.display = 'block';
            divSelect.style.display = 'none';
            divFile.style.display = 'block';
            btn.innerText = 'ä¸Šå‚³ä¸¦æ–°å¢åº—å®¶';
            btn.className = 'btn btn-primary w-100 mt-3';
        } else if (mode === 'edit') {
            divNew.style.display = 'none';
            divSelect.style.display = 'block';
            divFile.style.display = 'block';
            btn.innerText = 'æ›´æ–°åº—å®¶èœå–®';
            btn.className = 'btn btn-warning w-100 mt-3';
        } else if (mode === 'delete') {
            divNew.style.display = 'none';
            divSelect.style.display = 'block';
            divFile.style.display = 'none'; // åˆªé™¤æ¨¡å¼ä¸éœ€è¦ä¸Šå‚³åœ–ç‰‡
            btn.innerText = 'ç¢ºå®šåˆªé™¤åº—å®¶';
            btn.className = 'btn btn-danger w-100 mt-3';
        }
    }

    function resetAdminUI() {
        document.getElementById('adminMode').value = '';
        toggleAdminUI();
    }

    // --- è¼‰å…¥åº—å®¶è³‡æ–™ ---
    db.collection("menu").onSnapshot(snap => {
        const sel = document.getElementById('shopSelect');
        const admSel = document.getElementById('adminShopSelect');
        sel.innerHTML = '<option value="">é¸æ“‡åº—å®¶</option>';
        admSel.innerHTML = '<option value="">è«‹é¸æ“‡è¦è™•ç†çš„åº—å®¶</option>';
        shopData = {};
        snap.forEach(doc => {
            shopData[doc.id] = doc.data();
            sel.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
            admSel.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
        });
    });

    // --- ç®¡ç†åŸ·è¡Œå‹•ä½œ (ä¿®æ­£ç²å– shopName çš„ä¾†æº) ---
    async function handleAdminAction() {
        const mode = document.getElementById('adminMode').value;
        let shopName = "";
        
        if (mode === 'add') {
            shopName = document.getElementById('adminNewName').value.trim();
        } else {
            shopName = document.getElementById('adminShopSelect').value;
        }

        if (!shopName || shopName === "è«‹é¸æ“‡è¦è™•ç†çš„åº—å®¶") return alert("è«‹å¡«å¯«æˆ–é¸æ“‡åº—å®¶åç¨±");

        if (mode === 'delete') {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${shopName}ã€å—ï¼Ÿ`)) return;
            await db.collection("menu").doc(shopName).delete();
            alert("åº—å®¶å·²åˆªé™¤");
            resetAdminUI();
            bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
            return;
        }

        // æ–°å¢èˆ‡ä¿®æ”¹æ¨¡å¼
        const file = document.getElementById('adminFile').files[0];
        if (!file) return alert("è«‹é¸æ“‡èœå–®åœ–ç‰‡æª”æ¡ˆ");

        const btn = document.getElementById('adminSubmitBtn');
        const progDiv = document.getElementById('uploadProgress');
        const progBar = document.getElementById('progressBar');
        btn.disabled = true;
        progDiv.style.display = 'flex';

        const storageRef = storage.ref(`menus/${shopName}_${Date.now()}`);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            s => {
                const p = Math.round((s.bytesTransferred / s.totalBytes) * 100);
                progBar.style.width = p + '%'; progBar.innerText = p + '%';
            }, 
            err => { alert("éŒ¯èª¤ï¼š" + err.message); btn.disabled = false; }, 
            async () => {
                const url = await uploadTask.snapshot.ref.getDownloadURL();
                await db.collection("menu").doc(shopName).set({ imageUrl: url });
                alert("ğŸ‰ æ“ä½œæˆåŠŸï¼");
                btn.disabled = false;
                progDiv.style.display = 'none';
                resetAdminUI();
                bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
            }
        );
    }

    // (å…¶é¤˜å‰å°åŠŸèƒ½ submitOrder, checkShopImage, startListening, copySummary, toggleIceSelect ä¿æŒä¸è®Š)
    // ... 
    
    // åˆå§‹åŒ–å‘¼å«
    const todayQuery = new Date().toISOString().split('T')[0];
    document.getElementById('queryDate').value = todayQuery;
    
    // é€™è£¡è£œä¸Šä¹‹å‰çš„å…¶é¤˜ JS é‚è¼¯...
    function toggleIceSelect() {
        const temp = document.getElementById('tempSelect').value;
        const ice = document.getElementById('ice');
        if (temp === 'ç†±') { ice.value = "å»å†°"; ice.disabled = true; } else { ice.disabled = false; }
    }

    function checkShopImage() {
        const s = document.getElementById('shopSelect').value, btn = document.getElementById('viewMenuBtn'), img = document.getElementById('menuImg');
        if(s && shopData[s]?.imageUrl) { btn.style.display = 'block'; img.src = shopData[s].imageUrl; } else { btn.style.display = 'none'; }
    }

    function submitOrder() {
        const name = document.getElementById('userName').value.trim();
        const item = document.getElementById('manualName').value.trim();
        const priceInput = document.getElementById('manualPrice').value;
        const shop = document.getElementById('shopSelect').value;
        const temp = document.getElementById('tempSelect').value;
        if(!name || !shop || !item || !priceInput) return alert("ğŸ“¢ è«‹å¡«å¯«å®Œæ•´é»é¤è³‡è¨Š");
        const price = parseInt(priceInput);
        db.collection("orders").add({
            name, item, price, shop, temp,
            detail: `${temp} / ${document.getElementById('sugar').value} / ${document.getElementById('ice').value}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            const icon = temp === 'ç†±' ? 'â™¨ï¸' : 'ğŸ§Š';
            document.getElementById('successMsgHeader').innerText = `è¬è¬ ${name} æ‚¨çš„è¨‚å–®`;
            document.getElementById('successMsgDetail').innerText = `æœ¬æ¬¡è¨‚å–®ï¼š(${shop})(${icon}${item})(${price}å…ƒ)`;
            new bootstrap.Modal(document.getElementById('successModal')).show();
            document.getElementById('manualName').value = ""; document.getElementById('manualPrice').value = "";
        });
    }

    function startListening() {
        const d = document.getElementById('queryDate').value;
        const start = new Date(d); start.setHours(0,0,0,0);
        const end = new Date(d); end.setHours(23,59,59,999);
        if (unsubscribeOrders) unsubscribeOrders();
        unsubscribeOrders = db.collection("orders").where("timestamp", ">=", start).where("timestamp", "<=", end).orderBy("timestamp", "desc").onSnapshot(snap => {
            const list = document.getElementById('orderList'), summaryArea = document.getElementById('summaryArea');
            let shopTotals = {}; todayOrders = []; list.innerHTML = "";
            snap.forEach(doc => {
                const data = doc.data(); todayOrders.push(data);
                const sn = data.shop || "æœªæŒ‡å®š", p = Number(data.price) || 0;
                if (!shopTotals[sn]) shopTotals[sn] = { c: 0, s: 0 };
                shopTotals[sn].c++; shopTotals[sn].s += p;
                const icon = data.temp === 'ç†±' ? 'â™¨ï¸' : 'ğŸ§Š';
                list.innerHTML += `<div class="order-card"><b>${data.name}</b> [${sn}] ${icon}${data.item} ($${p})<br><small class="text-muted">${data.detail}</small></div>`;
            });
            let html = `ğŸ’° ${d} çµ±è¨ˆï¼š`, colors = ['primary', 'success', 'info', 'warning', 'danger'], ci = 0;
            for (let s in shopTotals) {
                const c = colors[ci % colors.length];
                html += `<div class="summary-item bg-light text-${c} border border-${c}"><span>ğŸ  ${s}</span><span>${shopTotals[s].c}æ¯ / ${shopTotals[s].s}å…ƒ</span></div>`;
                ci++;
            }
            summaryArea.innerHTML = Object.keys(shopTotals).length ? html : `ğŸ“… ${d} å°šç„¡è¨‚å–®`;
        });
    }

    function copySummary() {
        if(!todayOrders.length) return alert("ç„¡è¨‚å–®");
        let txt = `ğŸ¥¤ ${document.getElementById('queryDate').value} çµ±è¨ˆï¼š\n\n`;
        todayOrders.forEach((o, i) => txt += `${i+1}. ${o.name}: [${o.shop}] ${o.temp}${o.item} ($${o.price}) - ${o.detail}\n`);
        navigator.clipboard.writeText(txt).then(() => alert("ğŸ“‹ å…§å®¹å·²è¤‡è£½ï¼"));
    }

    startListening();
</script>
</body>
</html>